<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>On Rotation Generator</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#fff; }
    .app{ max-width:520px; margin:0 auto; padding:12px; display:grid; gap:12px; }
    .card{ border:1px solid rgba(0,0,0,.12); border-radius:18px; overflow:hidden; background:#f3f3f3; position:relative; }
    canvas{ width:100%; height:auto; display:block; }
    .hint{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#666; text-align:center; padding:18px; font-weight:600; pointer-events:none; }
    .panel{ border:1px solid rgba(0,0,0,.12); border-radius:18px; padding:12px; }
    label{ display:block; font-size:13px; font-weight:700; margin:10px 0; }
    input[type="text"], textarea{ width:100%; box-sizing:border-box; margin-top:6px; padding:10px 12px; border-radius:14px; border:1px solid rgba(0,0,0,.18); font-size:14px; }
    textarea{ height:150px; resize:vertical; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    button{ width:100%; padding:12px; border-radius:14px; border:0; font-weight:800; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .note{ margin-top:10px; font-size:12px; opacity:.75; line-height:1.35; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <canvas id="c" width="1080" height="1920"></canvas>
      <div id="hint" class="hint">Upload a photo or video to start</div>
    </div>

    <div class="panel">
      <label>
        Background (photo or video)
        <input id="file" type="file" accept="image/*,video/*" />
      </label>

      <label>
        Title
        <input id="title" type="text" value="my rotation" />
      </label>

      <label>
        Lines (one per line)
        <textarea id="lines" spellcheck="false">wake up
boat
write
work
swim
2k
edit
sleep</textarea>
      </label>

      <div class="row">
        <label>
          Text size
          <input id="size" type="range" min="40" max="120" value="78" />
        </label>

        <label>
          JPEG quality
          <input id="q" type="range" min="60" max="95" value="90" />
        </label>
      </div>

      <button id="jpg" disabled>Export JPEG</button>

      <div class="note" id="note"></div>
    </div>

    <video id="v" playsinline muted loop style="display:none;"></video>
  </div>

  <script>
    (() => {
      const W=1080, H=1920;
      const canvas=document.getElementById("c");
      const ctx=canvas.getContext("2d");
      const hint=document.getElementById("hint");
      const file=document.getElementById("file");
      const title=document.getElementById("title");
      const lines=document.getElementById("lines");
      const size=document.getElementById("size");
      const q=document.getElementById("q");
      const jpg=document.getElementById("jpg");
      const note=document.getElementById("note");
      const video=document.getElementById("v");
      const img=new Image();

      let mode=null; // "image" | "video"
      let ready=false;
      let raf=null;

      function cover(source, sw, sh){
        const scale=Math.max(W/sw, H/sh);
        const cw=W/scale, ch=H/scale;
        const sx=(sw-cw)/2, sy=(sh-ch)/2;
        ctx.drawImage(source, sx, sy, cw, ch, 0, 0, W, H);
      }

      function drawText(){
        const t=(title.value||"").trim();
        const ls=(lines.value||"").split("\\n").map(s=>s.trim()).filter(Boolean);
        const fs=Number(size.value);

        ctx.fillStyle="rgba(0,0,0,0.12)";
        ctx.fillRect(0,0,W,H);

        ctx.fillStyle="white";
        ctx.shadowColor="rgba(0,0,0,0.35)";
        ctx.shadowBlur=10;
        ctx.shadowOffsetX=0;
        ctx.shadowOffsetY=6;

        if(t){
          ctx.textAlign="center";
          ctx.font=`800 ${Math.round(fs*0.75)}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
          ctx.fillText(t, W*0.53, H*0.14);
        }

        ctx.textAlign="left";
        ctx.font=`900 ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
        const leftX=W*0.12;
        const startY=H*0.38;
        const lh=Math.round(fs*1.05);
        ls.forEach((line,i)=>ctx.fillText(line,leftX,startY+i*lh));

        ctx.shadowColor="transparent";
        ctx.shadowBlur=0;
        ctx.shadowOffsetX=0;
        ctx.shadowOffsetY=0;
      }

      function renderOnce(){
        ctx.clearRect(0,0,W,H);
        if(!ready){
          ctx.fillStyle="#f3f3f3";
          ctx.fillRect(0,0,W,H);
          return;
        }
        if(mode==="image"){
          cover(img, img.width, img.height);
          drawText();
        } else if(mode==="video"){
          if(video.videoWidth && video.videoHeight){
            cover(video, video.videoWidth, video.videoHeight);
            drawText();
          }
        }
      }

      function startLoop(){
        if(raf) cancelAnimationFrame(raf);
        const tick=()=>{ renderOnce(); raf=requestAnimationFrame(tick); };
        tick();
      }
      function stopLoop(){
        if(raf) cancelAnimationFrame(raf);
        raf=null;
      }

      function setButtons(){
        jpg.disabled=!ready;
      }

      file.addEventListener("change", async (e) => {
        const f=e.target.files && e.target.files[0];
        if(!f) return;

        ready=false;
        hint.style.display="none";
        stopLoop();

        const url=URL.createObjectURL(f);

        if(f.type.startsWith("image/")){
          mode="image";
          video.pause(); video.removeAttribute("src"); video.load();

          img.onload=()=>{
            ready=true;
            renderOnce();
            setButtons();
            note.textContent="Photo loaded. Export as JPEG.";
            URL.revokeObjectURL(url);
          };
          img.src=url;

        } else if(f.type.startsWith("video/")){
          mode="video";
          video.onloadeddata=async ()=>{
            ready=true;
            try{ await video.play(); }catch(_){}
            startLoop();
            setButtons();
            note.textContent="Video loaded. Export grabs the current frame as a JPEG (reliable on iPhone).";
          };
          video.src=url;
          video.load();
        } else {
          note.textContent="Unsupported file type.";
          URL.revokeObjectURL(url);
        }

        setButtons();
      });

      [title, lines, size].forEach(el=>el.addEventListener("input", ()=>{ if(mode==="image") renderOnce(); }));

      jpg.addEventListener("click", ()=>{
        if(!ready) return;
        renderOnce();
        const quality=Number(q.value)/100;
        const a=document.createElement("a");
        a.download="on-rotation.jpg";
        a.href=canvas.toDataURL("image/jpeg", quality);
        a.click();
      });

      renderOnce();
      setButtons();
      note.textContent="Upload a photo/video to begin.";
    })();
  </script>
</body>
</html>
